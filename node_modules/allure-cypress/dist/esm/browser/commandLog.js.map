{"version":3,"file":"commandLog.js","names":["isDefined","reportStepStart","serializePropValue","getCurrentStep","getStepStack","pushStep","setupStepFinalization","ALLURE_STEP_CMD_SUBJECT","findAndStopStepWithSubsteps","isLogStep","shouldCreateStepFromCommandLogEntry","entry","event","instrument","attributes","isApiStepErrorLogEntry","setupScreenshotAttachmentStep","originalName","name","step","commandName","props","nameFromProps","log","consoleProps","attachmentName","startCommandLogStep","currentLogEntry","getCurrentLogEntry","shouldStopCurrentLogStep","stopCommandLogStep","id","pushLogEntry","getCommandLogStepName","scheduleCommandLogStepStop","entryId","_ref","stepDescriptor","type","data","parameters","getCommandLogStepParameters","groupStart","end","originalEndGroup","endGroup","call","originalEnd","_ref2","Object","is","_ref3","_ref4","_maybeGetAssertionLog","message","displayName","resolvedName","trim","resolvedMessage","maybeGetAssertionLogMessage","maybeGetCucumberLogMessage","renderProps","stepName","filter","Boolean","join","getLogProps","map","_ref5","k","v","toString","value","getPropValueSetFilter","WELL_KNOWN_CUCUMBER_LOG_NAMES","includes","startsWith","endsWith","substring","length","isAssertionWithMessage","entries","_ref6","isAssertLog","Message","_ref7","findLast","newLogEntry","currentEntryIsGroup","currentEntryType","newEntryType","_ref8"],"sources":["../../../src/browser/commandLog.ts"],"sourcesContent":["import type { Parameter } from \"allure-js-commons\";\nimport type { CypressLogEntry, LogStepDescriptor } from \"../types.js\";\nimport { isDefined } from \"../utils.js\";\nimport { reportStepStart } from \"./lifecycle.js\";\nimport serializePropValue from \"./serialize.js\";\nimport { getCurrentStep, getStepStack, pushStep, setupStepFinalization } from \"./state.js\";\nimport { ALLURE_STEP_CMD_SUBJECT, findAndStopStepWithSubsteps, isLogStep } from \"./steps.js\";\n\nexport const shouldCreateStepFromCommandLogEntry = (entry: CypressLogEntry) => {\n  const { event, instrument } = entry.attributes;\n  if (instrument !== \"command\") {\n    // We are interested in the \"TEST BODY\" panel only for now.\n    // Other instruments are logged in separate panels.\n    return false;\n  }\n\n  if (event) {\n    // Events are tricky to report as they may span across commands and even leave the test's scope.\n    // We ignore them for now.\n    return false;\n  }\n\n  if (isApiStepErrorLogEntry(entry)) {\n    // Cypress don't create a log message for 'cy.then' except when it throws an error.\n    // This is in particularly happens when the function passed to 'allure.step' throws. In such a case however,\n    // creating an extra step from the log entry is redundant because the error is already included in the report as\n    // a part of the step.\n    return false;\n  }\n\n  return true;\n};\n\n/**\n * Checks if the current step represents a cy.screenshot command log entry. If this is the case, associates the name\n * of the screenshot with the step. Later, that will allow converting the step with the attachment into the attachment\n * step.\n */\nexport const setupScreenshotAttachmentStep = (originalName: string | undefined, name: string) => {\n  const step = getCurrentStep();\n  if (step && isLogStep(step)) {\n    const {\n      name: commandName,\n      props: { name: nameFromProps },\n    } = step.log.attributes.consoleProps();\n    if (commandName === \"screenshot\" && nameFromProps === originalName) {\n      step.attachmentName = name;\n    }\n  }\n};\n\nexport const startCommandLogStep = (entry: CypressLogEntry) => {\n  const currentLogEntry = getCurrentLogEntry();\n\n  if (typeof currentLogEntry !== \"undefined\" && shouldStopCurrentLogStep(currentLogEntry.log, entry)) {\n    stopCommandLogStep(currentLogEntry.log.attributes.id);\n  }\n\n  pushLogEntry(entry);\n  reportStepStart(entry.attributes.id, getCommandLogStepName(entry));\n  scheduleCommandLogStepStop(entry);\n};\n\nexport const stopCommandLogStep = (entryId: string) => findAndStopStepWithSubsteps(({ id }) => id === entryId);\n\nconst pushLogEntry = (entry: CypressLogEntry) => {\n  const id = entry.attributes.id;\n  const stepDescriptor: LogStepDescriptor = { id, type: \"log\", log: entry };\n\n  pushStep(stepDescriptor);\n\n  // Some properties of some Command Log entries are undefined at the time the entry is stopped. An example is the\n  // Yielded property of some queries. We defer converting them to Allure step parameters until the test/hook ends.\n  setupStepFinalization(stepDescriptor, (data) => {\n    data.parameters = getCommandLogStepParameters(entry);\n\n    if (stepDescriptor.attachmentName) {\n      // Rename the step to match the attachment name. Once the names are the same, Allure will render the\n      // attachment in the place of the step.\n      data.name = stepDescriptor.attachmentName;\n    }\n  });\n};\n\nconst scheduleCommandLogStepStop = (entry: CypressLogEntry) => {\n  const { groupStart, end, id } = entry.attributes;\n  if (end) {\n    // Some entries are already completed (this is similar to the idea behind allure.logStep).\n    // Cypress won't call entry.end() in such a case, so we need to stop such a step now.\n    // Example: cy.log\n    stopCommandLogStep(id);\n  } else if (groupStart) {\n    // A logging group must be stopped be the user via the Cypress.Log.endGroup() call.\n    // If the call is missing, the corresponding step will be stopped either at the test's (the hook's) end.\n    const originalEndGroup = entry.endGroup;\n    entry.endGroup = function () {\n      stopCommandLogStep(id);\n      return originalEndGroup.call(this);\n    };\n  } else {\n    // Regular log entries are finalized by Cypress via the Cypress.Log.end() call. We're hooking into this function\n    // to complete the step at the same time.\n    // eslint-disable-next-line @typescript-eslint/unbound-method\n    const originalEnd = entry.end;\n    entry.end = function () {\n      stopCommandLogStep(id);\n      return originalEnd.call(this);\n    };\n  }\n};\n\nconst isApiStepErrorLogEntry = ({ attributes: { name, consoleProps } }: CypressLogEntry) =>\n  name === \"then\" && Object.is(consoleProps().props[\"Applied To\"], ALLURE_STEP_CMD_SUBJECT);\n\nconst getCommandLogStepName = (entry: CypressLogEntry) => {\n  const { name, message, displayName } = entry.attributes;\n  const resolvedName = (displayName ?? name).trim();\n  const resolvedMessage = (\n    maybeGetAssertionLogMessage(entry) ??\n    maybeGetCucumberLogMessage(entry) ??\n    entry.attributes.renderProps().message ??\n    message\n  ).trim();\n  const stepName = [resolvedName, resolvedMessage].filter(Boolean).join(\" \");\n  return stepName;\n};\n\nconst getCommandLogStepParameters = (entry: CypressLogEntry) =>\n  getLogProps(entry)\n    .map(([k, v]) => ({\n      name: k.toString(),\n      value: serializePropValue(v),\n    }))\n    .filter(getPropValueSetFilter(entry));\n\nconst WELL_KNOWN_CUCUMBER_LOG_NAMES = [\"Given\", \"When\", \"Then\", \"And\"];\n\nconst maybeGetCucumberLogMessage = (entry: CypressLogEntry) => {\n  const {\n    attributes: { name, message },\n  } = entry;\n  if (WELL_KNOWN_CUCUMBER_LOG_NAMES.includes(name.trim()) && message.startsWith(\"**\") && message.endsWith(\"**\")) {\n    return message.substring(2, message.length - 2);\n  }\n};\n\nconst getLogProps = (entry: CypressLogEntry) => {\n  const {\n    attributes: { consoleProps },\n  } = entry;\n  const isAssertionWithMessage = !!maybeGetAssertionLogMessage(entry);\n  const { props, name } = consoleProps();\n\n  // accessing LocalStorage after the page reload can stick the test runner\n  // to avoid the issue, we just need to log the command manually\n  // the problem potentially can happen with other storage related commands, like `clearAllLocalStorage`, `clearAllSessionStorage`, `getAllLocalStorage`, `getAllSessionStorage`, `setLocalStorage`, `setSessionStorage`\n  // but probably, we don't need to silent them all at this moment\n  // the context: https://github.com/allure-framework/allure-js/issues/1222\n  if ([\"clearLocalStorage\"].includes(name)) {\n    return [] as [string, unknown][];\n  }\n\n  // For assertion logs, we interpolate the 'Message' property, which contains unformatted assertion description,\n  // directly into the step's name.\n  // No need to keep the exact same information in the step's parameters.\n  return Object.entries(props).filter(([k, v]) => isDefined(v) && !(isAssertionWithMessage && k === \"Message\"));\n};\n\nconst maybeGetAssertionLogMessage = (entry: CypressLogEntry) => {\n  if (isAssertLog(entry)) {\n    const message = entry.attributes.consoleProps().props.Message;\n\n    if (message && typeof message === \"string\") {\n      return message;\n    }\n  }\n};\n\nconst isAssertLog = ({ attributes: { name } }: CypressLogEntry) => name === \"assert\";\n\nconst getCurrentLogEntry = () => getStepStack().findLast(isLogStep);\n\nconst shouldStopCurrentLogStep = (currentLogEntry: CypressLogEntry, newLogEntry: CypressLogEntry) => {\n  const { groupStart: currentEntryIsGroup, type: currentEntryType } = currentLogEntry.attributes;\n  const { type: newEntryType } = newLogEntry.attributes;\n\n  return !currentEntryIsGroup && (currentEntryType === \"child\" || newEntryType !== \"child\");\n};\n\nconst getPropValueSetFilter = (entry: CypressLogEntry) =>\n  entry.attributes.name === \"wrap\" ? () => true : ({ name, value }: Parameter) => name !== \"Yielded\" || value !== \"{}\";\n"],"mappings":"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","ignoreList":[]}