{"version":3,"file":"patching.js","names":["isPromise","completeSpecIfNoAfterHookLeft","completeSpecOnAfterHookFailure","throwAfterSpecCompletion","enableScopeLevelAfterHookReporting","suiteDepthCounter","createSuiteDepthCounterState","patchDescribe","patchAfter","suiteDepth","getSuiteDepth","incrementSuiteDepth","decrementSuiteDepth","_ref","patchDescribeFn","target","title","configOrFn","fn","forwardDescribeCall","originalDescribeFn","globalThis","describe","patchedDescribe","only","skip","_ref2","originalAfter","after","patchedAfter","nameOrFn","wrapRootAfterFn","_len","arguments","length","args","Array","_key","wrappedFn","wrapAfterFnWithCallback","wrapAfterFnWithoutArgs","Object","defineProperty","value","name","done","wrappedDone","hookError","_completeSpecOnAfterH","then","_completeSpecIfNoAfte","allureError","bind","result","syncError","e","asyncError"],"sources":["../../../src/browser/patching.ts"],"sourcesContent":["import { isPromise } from \"allure-js-commons/sdk\";\nimport type { CypressSuiteFunction, DirectHookImplementation, HookImplementation } from \"../types.js\";\nimport {\n  completeSpecIfNoAfterHookLeft,\n  completeSpecOnAfterHookFailure,\n  throwAfterSpecCompletion,\n} from \"./lifecycle.js\";\n\ntype SuiteDepthCounter = {\n  getSuiteDepth: () => number;\n  incrementSuiteDepth: () => void;\n  decrementSuiteDepth: () => void;\n};\n\n/**\n * Patches the `after` function, to inject reporting of spec-level\n * `after` hooks defined by the user.\n */\nexport const enableScopeLevelAfterHookReporting = () => {\n  const suiteDepthCounter = createSuiteDepthCounterState();\n  patchDescribe(suiteDepthCounter);\n  patchAfter(suiteDepthCounter);\n};\n\nconst createSuiteDepthCounterState = (): SuiteDepthCounter => {\n  let suiteDepth = 0;\n  return {\n    getSuiteDepth: () => suiteDepth,\n    incrementSuiteDepth: () => {\n      suiteDepth++;\n    },\n    decrementSuiteDepth: () => {\n      suiteDepth--;\n    },\n  };\n};\n\nconst patchDescribe = ({ incrementSuiteDepth, decrementSuiteDepth }: SuiteDepthCounter) => {\n  const patchDescribeFn =\n    (target: CypressSuiteFunction): CypressSuiteFunction =>\n    (title, configOrFn, fn) => {\n      incrementSuiteDepth();\n      try {\n        return forwardDescribeCall(target, title, configOrFn, fn);\n      } finally {\n        decrementSuiteDepth();\n      }\n    };\n  const originalDescribeFn: Mocha.SuiteFunction = globalThis.describe;\n  const patchedDescribe = patchDescribeFn(originalDescribeFn) as Mocha.SuiteFunction;\n  patchedDescribe.only = patchDescribeFn(\n    originalDescribeFn.only as CypressSuiteFunction,\n  ) as Mocha.ExclusiveSuiteFunction;\n  patchedDescribe.skip = patchDescribeFn(originalDescribeFn.skip as CypressSuiteFunction) as Mocha.PendingSuiteFunction;\n  globalThis.describe = patchedDescribe;\n};\n\nconst patchAfter = ({ getSuiteDepth }: SuiteDepthCounter) => {\n  const originalAfter = globalThis.after;\n  const patchedAfter = (nameOrFn: string | HookImplementation, fn?: HookImplementation): void => {\n    return typeof nameOrFn === \"string\"\n      ? originalAfter(nameOrFn, wrapRootAfterFn(getSuiteDepth, fn))\n      : originalAfter(wrapRootAfterFn(getSuiteDepth, nameOrFn)!);\n  };\n  globalThis.after = patchedAfter;\n};\n\nconst forwardDescribeCall = (target: CypressSuiteFunction, ...args: Parameters<CypressSuiteFunction>) => {\n  const [title, configOrFn, fn] = args;\n  if (typeof fn === \"undefined\" && typeof configOrFn === \"undefined\") {\n    return target(title);\n  } else if (typeof configOrFn === \"function\") {\n    return target(title, configOrFn);\n  } else {\n    return target(title, configOrFn, fn);\n  }\n};\n\nconst wrapRootAfterFn = (getSuiteDepth: () => number, fn?: HookImplementation): HookImplementation | undefined => {\n  if (getSuiteDepth() === 0 && fn) {\n    const wrappedFn = fn.length ? wrapAfterFnWithCallback(fn) : wrapAfterFnWithoutArgs(fn as DirectHookImplementation);\n    Object.defineProperty(wrappedFn, \"name\", { value: fn.name });\n    return wrappedFn;\n  }\n  return fn;\n};\n\nconst wrapAfterFnWithCallback = (fn: Mocha.Func): Mocha.Func => {\n  return function (this: Mocha.Context, done: Mocha.Done) {\n    const wrappedDone = (hookError?: Error) => {\n      if (hookError) {\n        if (!completeSpecOnAfterHookFailure(this, hookError)?.then(() => done(hookError))) {\n          done(hookError);\n        }\n        return;\n      }\n\n      try {\n        if (completeSpecIfNoAfterHookLeft(this)?.then(() => done())) {\n          return;\n        }\n      } catch (allureError) {\n        done(allureError);\n        return;\n      }\n\n      done();\n    };\n    return fn.bind(this)(wrappedDone);\n  };\n};\n\nconst wrapAfterFnWithoutArgs = (fn: DirectHookImplementation) => {\n  return function (this: Mocha.Context) {\n    let result;\n    let syncError: any;\n\n    try {\n      result = fn.bind(this)();\n    } catch (e) {\n      syncError = e;\n    }\n\n    if (syncError) {\n      throwAfterSpecCompletion(this, syncError);\n    } else if (isPromise(result)) {\n      return result.then(\n        () => completeSpecIfNoAfterHookLeft(this),\n        (asyncError) => throwAfterSpecCompletion(this, asyncError),\n      );\n    } else {\n      completeSpecIfNoAfterHookLeft(this);\n      return result;\n    }\n  };\n};\n"],"mappings":"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","ignoreList":[]}